<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<title>Chat OpenAI Streaming - Markdown Persistente</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
		<style>
			/* ... mismo CSS que el tuyo ... */
			html,
			body {
				height: 100%;
				margin: 0;
				padding: 0;
				width: 100vw;
			}
			body {
				background: #f8f9fa;
				min-height: 100vh;
				width: 100vw;
			}
			.chat-window {
				width: 100vw;
				height: 100vh;
				margin: 0;
				border-radius: 0;
				box-shadow: none;
				background: #fff;
				padding: 0;
				display: flex;
				flex-direction: column;
			}
			.chat-messages {
				flex: 1 1 auto;
				overflow-y: auto;
				padding: 16px;
				border-bottom: 1px solid #eee;
				background: #fff;
			}
			.message.user {
				text-align: right;
			}
			.message.openai {
				text-align: left;
			}
			.message span {
				display: inline-block;
				padding: 8px 12px;
				border-radius: 16px;
				margin: 6px 0;
				max-width: 80%;
				word-break: break-word;
			}
			.message.user span {
				background: #0d6efd;
				color: #fff;
			}
			.message.openai span {
				background: #e9ecef;
				color: #333;
			}
			.settings-toggle {
				cursor: pointer;
				color: #0d6efd;
				font-size: 1.1em;
				float: right;
			}
			.settings-panel {
				display: none;
				border-bottom: 1px solid #eee;
				padding: 16px;
				background: #f7f7f7;
			}
			.settings-panel.show {
				display: block;
			}
			.message.openai span h1,
			.message.openai span h2,
			.message.openai span h3 {
				margin-top: 0.5em;
			}
			.message.openai span table {
				width: 100%;
			}
			.message.openai span table,
			.message.openai span th,
			.message.openai span td {
				border: 1px solid #dee2e6;
				border-collapse: collapse;
			}
			.message.openai span th,
			.message.openai span td {
				padding: 0.5em;
			}
			.message.openai span ul,
			.message.openai span ol {
				padding-left: 1.5em;
			}
			.message.openai span code {
				background: #f1f3f5;
				padding: 2px 6px;
				border-radius: 4px;
			}
			.message.openai span pre {
				background: #f1f3f5;
				padding: 8px;
				border-radius: 6px;
			}
			@media (max-width: 600px) {
				.chat-window {
					width: 100vw;
					height: 100vh;
					border-radius: 0;
					margin: 0;
				}
				.chat-messages {
					padding: 8px;
				}
				.settings-panel,
				.p-3 {
					padding: 8px !important;
				}
				.message span {
					max-width: 100%;
					font-size: 1em;
				}
			}
			code,
			pre {
				font-family: 'Fira Mono', 'Consolas', monospace;
			}
			.speed-indicator {
				font-size: 0.85em;
				color: #888;
				padding-left: 1em;
			}
			.new-chat-btn {
				margin-right: 10px;
				background: #198754;
				color: white;
				border: none;
				padding: 5px 16px;
				border-radius: 20px;
				font-size: 1em;
				cursor: pointer;
				transition: background 0.2s;
			}
			.new-chat-btn:hover {
				background: #157347;
			}
			.chat-id-tag {
				font-size: 0.75em;
				color: #888;
				font-family: monospace;
				background: #eee;
				padding: 1px 7px;
				border-radius: 12px;
				margin-left: 8px;
			}
		</style>
	</head>
	<body>
		<div class="chat-window">
			<div
				class="p-3 border-bottom d-flex align-items-center justify-content-between"
			>
				<span class="fw-bold">
					Chat OpenAI <small class="text-secondary">Streaming Markdown</small>
					<span
						id="chatIdTag"
						class="chat-id-tag"
						title="ID de conversación"
					></span>
				</span>
				<div>
					<button class="new-chat-btn" id="newChatBtn" title="Nuevo chat">
						Nuevo chat
					</button>
					<span
						class="settings-toggle"
						id="settingsToggle"
						title="Configuración"
						>&#9881;</span
					>
				</div>
			</div>
			<div class="settings-panel" id="settingsPanel">
				<form id="settingsForm" autocomplete="off">
					<div class="mb-2">
						<label class="form-label">URL base (hasta /v1)</label>
						<input type="text" class="form-control" id="urlBase" required />
					</div>
					<div class="mb-2">
						<label class="form-label">Clave API</label>
						<input type="text" class="form-control" id="apiKey" required />
					</div>
					<div class="mb-2">
						<label class="form-label">Modelo</label>
						<input type="text" class="form-control" id="model" required />
					</div>
					<div class="mb-2">
						<label class="form-label">System prompt</label>
						<textarea
							class="form-control"
							id="systemPrompt"
							rows="2"
							placeholder="Ejemplo: Eres un asistente útil y conciso."
						></textarea>
						<small class="text-secondary"
							>Controla el comportamiento de la IA.</small
						>
					</div>
					<button type="submit" class="btn btn-primary btn-sm w-100">
						Guardar configuración
					</button>
				</form>
			</div>
			<div class="chat-messages" id="chatMessages"></div>
			<form class="d-flex p-3 gap-2" id="chatForm" autocomplete="off">
				<input
					type="text"
					class="form-control flex-grow-1"
					id="userInput"
					placeholder="Escribe tu mensaje..."
					required
				/>
				<button class="btn btn-primary flex-shrink-0" type="submit">
					Enviar
				</button>
			</form>
		</div>
		<script>
			// --------- CHATID utility ---------
			function getOrCreateChatId() {
				const params = new URLSearchParams(window.location.search);
				let chatId = params.get('chat');
				if (!chatId) {
					chatId =
						self.crypto?.randomUUID?.() ||
						Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
					params.set('chat', chatId);
					window.history.replaceState(null, '', '?' + params.toString());
				}
				return chatId;
			}
			const chatId = getOrCreateChatId();
			document.getElementById('chatIdTag').textContent = chatId;

			// --------- SETTINGS ---------
			const settingsPanel = document.getElementById('settingsPanel');
			const settingsToggle = document.getElementById('settingsToggle');
			const settingsForm = document.getElementById('settingsForm');
			const urlBaseInput = document.getElementById('urlBase');
			const apiKeyInput = document.getElementById('apiKey');
			const modelInput = document.getElementById('model');
			const systemPromptInput = document.getElementById('systemPrompt');

			function loadConfig() {
				const config =
					JSON.parse(localStorage.getItem('chatConfig-global')) || {};
				urlBaseInput.value = config.urlBase || 'https://api.openai.com/v1';
				apiKeyInput.value = config.apiKey || '';
				modelInput.value = config.model || 'gpt-3.5-turbo';
				systemPromptInput.value = config.systemPrompt || '';
			}
			loadConfig();
			settingsToggle.onclick = () => {
				settingsPanel.classList.toggle('show');
			};
			settingsForm.onsubmit = e => {
				e.preventDefault();
				const config = {
					urlBase: urlBaseInput.value.trim(),
					apiKey: apiKeyInput.value.trim(),
					model: modelInput.value.trim(),
					systemPrompt: systemPromptInput.value.trim(),
				};
				localStorage.setItem('chatConfig-global', JSON.stringify(config));
				settingsPanel.classList.remove('show');
				showAlert('Configuración guardada correctamente.');
			};

			// --------- AUTOSAVE CONTROL ---------
			let autosaveEnabled = false;
			let conversation = [];
			const chatMessages = document.getElementById('chatMessages');
			const chatForm = document.getElementById('chatForm');
			const userInput = document.getElementById('userInput');

			function saveConversation() {
				if (!autosaveEnabled) return;
				localStorage.setItem(
					'chatHistory-' + chatId,
					JSON.stringify(conversation),
				);
			}

			function restoreHistory() {
				autosaveEnabled = false;
				let raw = localStorage.getItem('chatHistory-' + chatId);
				chatMessages.innerHTML = '';
				if (raw) {
					try {
						let history = JSON.parse(raw) || [];
						if (
							history.length > 0 &&
							history[history.length - 1].role === 'user'
						) {
							history.pop();
						}
						history = history.filter(
							msg => !(msg.role === 'assistant' && !msg.content),
						);
						conversation = history;
						for (let idx = 0; idx < conversation.length; idx++) {
							const msg = conversation[idx];
							addMessage(msg.content, msg.role === 'user' ? 'user' : 'openai');
						}
					} catch (e) {
						conversation = [];
						localStorage.removeItem('chatHistory-' + chatId);
					}
				} else {
					conversation = [];
				}
				autosaveEnabled = true;
			}

			function addMessage(inner, sender) {
				const div = document.createElement('div');
				div.className = `message ${sender}`;
				div.innerHTML = `<span>${
					sender === 'openai' ? marked.parse(inner) : inner
				}</span>`;
				chatMessages.appendChild(div);
				chatMessages.scrollTop = chatMessages.scrollHeight;
			}

			// --------- STREAMING OPENAI ---------
			async function streamOpenAI({
				urlBase,
				apiKey,
				model,
				conversation,
				onChunk,
				onDone,
				onError,
			}) {
				const startTime = performance.now();
				let lastText = '';
				let tokenCount = 0;
				let done = false;
				try {
					const response = await fetch(urlBase + '/chat/completions', {
						method: 'POST',
						headers: {
							Authorization: urlBase.includes('openai.azure.com')
								? apiKey
								: 'Bearer ' + apiKey,
							'api-key': urlBase.includes('openai.azure.com')
								? apiKey
								: undefined,
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							model,
							messages: conversation,
							stream: true,
						}),
					});

					if (!response.ok) throw new Error('Error en la respuesta');
					const reader = response.body.getReader();
					let decoder = new TextDecoder('utf-8');
					let buffer = '';

					while (true) {
						const { value, done: doneReading } = await reader.read();
						if (doneReading) break;
						buffer += decoder.decode(value, { stream: true });

						let lines = buffer.split('\n');
						buffer = lines.pop();

						for (let line of lines) {
							line = line.trim();
							if (line === '' || !line.startsWith('data:')) continue;
							let jsonStr = line.replace('data: ', '').trim();
							if (jsonStr === '[DONE]') {
								done = true;
								break;
							}
							try {
								const parsed = JSON.parse(jsonStr);
								const delta = parsed.choices[0].delta?.content || '';
								if (delta) {
									lastText += delta;
									tokenCount++;
									onChunk(
										lastText,
										tokenCount,
										(performance.now() - startTime) / 1000,
									);
								}
							} catch (e) {}
						}
						if (done) break;
					}
					onDone(lastText, tokenCount, (performance.now() - startTime) / 1000);
				} catch (err) {
					onError(err);
				}
			}

			// --------- RESTAURAR HISTORIAL AL INICIAR ---------
			restoreHistory();

			// --------- STREAMING Y ENVÍO ----------
			let messageCounter = 0;

			chatForm.addEventListener('submit', function (e) {
				e.preventDefault();
				const text = userInput.value.trim();
				if (!text) return;
				addMessage(text, 'user');
				userInput.value = '';

				const config =
					JSON.parse(localStorage.getItem('chatConfig-global')) || {};
				const sysPrompt = config.systemPrompt || '';

				conversation.push({ role: 'user', content: text }); // <-- ¡Primero aquí!
				saveConversation();

				let convToSend = conversation.slice();
				if (
					sysPrompt &&
					!(convToSend.length > 0 && convToSend[0].role === 'system')
				) {
					convToSend = [{ role: 'system', content: sysPrompt }, ...convToSend];
				}

				conversation.push({ role: 'user', content: text });
				saveConversation();

				messageCounter++;
				const replyId = `streamreply-${messageCounter}`;
				const speedId = `speed-${messageCounter}`;
				const htmlStream = `<span id="${replyId}"></span><br><small id="${speedId}" class="speed-indicator"></small>`;
				addMessage(htmlStream, 'openai');
				const replyElem = document.getElementById(replyId);
				const speedElem = document.getElementById(speedId);
				let msgDiv = chatMessages.lastChild;

				let lastRendered = 0;
				const RENDER_EACH = 10;

				streamOpenAI({
					urlBase: urlBaseInput.value.trim(),
					apiKey: apiKeyInput.value.trim(),
					model: modelInput.value.trim(),
					conversation: convToSend,
					onChunk: (content, tokens, seconds) => {
						if (tokens - lastRendered >= RENDER_EACH || tokens === 1) {
							replyElem.innerHTML = marked.parse(content);
							lastRendered = tokens;
						}
						if (tokens > 0)
							speedElem.innerText = `Tokens: ${tokens} • Vel: ${(
								tokens / (seconds || 1)
							).toFixed(2)} tks/seg`;
						msgDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
					},
					onDone: (content, tokens, seconds) => {
						if (content) {
							conversation.push({ role: 'assistant', content });
							saveConversation();
						}
						replyElem.innerHTML = marked.parse(content);
						speedElem.innerText = `Completado. Total tokens: ${tokens}, Vel máxima: ${(
							tokens / (seconds || 1)
						).toFixed(2)} tks/seg`;
					},
					onError: err => {
						chatMessages.lastChild.remove();
						addMessage('Error al conectar (streaming falló).', 'openai');
					},
				});
			});

			// --------- NUEVO CHAT ----------
			const newChatBtn = document.getElementById('newChatBtn');
			newChatBtn.addEventListener('click', function () {
				if (
					confirm(
						'¿Seguro que quieres empezar un nuevo chat? Se borrará la conversación actual.',
					)
				) {
					const newId =
						self.crypto?.randomUUID?.() ||
						Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
					window.location.search = '?chat=' + newId;
				}
			});

			// --------- NOTIFICACIÓN ---------
			function showAlert(text, timeout = 1800) {
				let div = document.createElement('div');
				div.className = 'alert alert-success position-fixed shadow';
				div.style =
					'top: 16px; left:50%; transform:translateX(-50%); z-index:1000; min-width:200px; text-align:center;';
				div.textContent = text;
				document.body.appendChild(div);
				setTimeout(() => div.remove(), timeout);
			}
		</script>
	</body>
</html>
