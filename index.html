<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Chat OpenAI Streaming - Persistent Markdown</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ... Same CSS as yours, unchanged ... */
        /* --- OMITTED FOR BREVITY --- */
    </style>
</head>
<body>
    <div class="chat-window">
        <div class="p-3 border-bottom d-flex align-items-center justify-content-between">
            <span class="fw-bold">
                Chat OpenAI <small class="text-secondary">Streaming Markdown</small>
                <span
                    id="chatIdTag"
                    class="chat-id-tag"
                    title="Conversation ID"
                ></span>
            </span>
            <div>
                <button class="new-chat-btn" id="newChatBtn" title="New chat">
                    New chat
                </button>
                <span
                    class="settings-toggle"
                    id="settingsToggle"
                    title="Settings"
                    >&#9881;</span
                >
            </div>
        </div>
        <div class="settings-panel" id="settingsPanel">
            <form id="settingsForm" autocomplete="off">
                <div class="mb-2">
                    <label class="form-label">Base URL (up to /v1)</label>
                    <input type="text" class="form-control" id="urlBase" required />
                </div>
                <div class="mb-2">
                    <label class="form-label">API Key</label>
                    <input type="text" class="form-control" id="apiKey" required />
                </div>
                <div class="mb-2">
                    <label class="form-label">Model</label>
                    <input type="text" class="form-control" id="model" required />
                </div>
                <div class="mb-2">
                    <label class="form-label">System prompt</label>
                    <textarea
                        class="form-control"
                        id="systemPrompt"
                        rows="2"
                        placeholder="Example: You are a helpful and concise assistant."
                    ></textarea>
                    <small class="text-secondary"
                        >Controls AI behavior.</small
                    >
                </div>
                <button type="submit" class="btn btn-primary btn-sm w-100">
                    Save settings
                </button>
            </form>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <form class="d-flex p-3 gap-2" id="chatForm" autocomplete="off">
            <input
                type="text"
                class="form-control flex-grow-1"
                id="userInput"
                placeholder="Type your message..."
                required
            />
            <button class="btn btn-primary flex-shrink-0" type="submit">
                Send
            </button>
        </form>
    </div>
    <script>
        // --------- CHATID utility ---------
        const getOrCreateChatId = () => {
            const params = new URLSearchParams(window.location.search);
            let chatId = params.get('chat');
            if (!chatId) {
                chatId =
                    self.crypto?.randomUUID?.() ||
                    `${Date.now().toString(36)}${Math.random().toString(36).substring(2, 8)}`;
                params.set('chat', chatId);
                window.history.replaceState(null, '', `?${params.toString()}`);
            }
            return chatId;
        };

        const chatId = getOrCreateChatId();
        document.getElementById('chatIdTag').textContent = chatId;

        // --------- SETTINGS ---------
        const settingsPanel = document.getElementById('settingsPanel');
        const settingsToggle = document.getElementById('settingsToggle');
        const settingsForm = document.getElementById('settingsForm');
        const urlBaseInput = document.getElementById('urlBase');
        const apiKeyInput = document.getElementById('apiKey');
        const modelInput = document.getElementById('model');
        const systemPromptInput = document.getElementById('systemPrompt');

        const loadConfig = () => {
            const config = JSON.parse(localStorage.getItem('chatConfig-global')) || {};
            urlBaseInput.value      = config.urlBase      || 'https://api.openai.com/v1';
            apiKeyInput.value       = config.apiKey       || '';
            modelInput.value        = config.model        || 'gpt-3.5-turbo';
            systemPromptInput.value = config.systemPrompt || '';
        };
        loadConfig();

        settingsToggle.onclick = () => {
            settingsPanel.classList.toggle('show');
        };

        settingsForm.onsubmit = e => {
            e.preventDefault();
            const config = {
                urlBase: urlBaseInput.value.trim(),
                apiKey: apiKeyInput.value.trim(),
                model: modelInput.value.trim(),
                systemPrompt: systemPromptInput.value.trim(),
            };
            localStorage.setItem('chatConfig-global', JSON.stringify(config));
            settingsPanel.classList.remove('show');
            showAlert('Settings saved successfully.');
        };

        // --------- AUTOSAVE CONTROL ---------
        let autosaveEnabled = false;
        let conversation = [];
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');

        const saveConversation = () => {
            if (!autosaveEnabled) return;
            localStorage.setItem(
                `chatHistory-${chatId}`,
                JSON.stringify(conversation),
            );
        };

        const restoreHistory = () => {
            autosaveEnabled = false;
            const raw = localStorage.getItem(`chatHistory-${chatId}`);
            chatMessages.innerHTML = '';
            if (raw) {
                try {
                    let history = JSON.parse(raw) || [];
                    if (history.length > 0 && history.at(-1).role === 'user') {
                        history.pop();
                    }
                    history = history.filter(
                        msg => !(msg.role === 'assistant' && !msg.content),
                    );
                    conversation = history;
                    for (const msg of conversation) {
                        addMessage(msg.content, msg.role === 'user' ? 'user' : 'openai');
                    }
                } catch {
                    conversation = [];
                    localStorage.removeItem(`chatHistory-${chatId}`);
                }
            } else {
                conversation = [];
            }
            autosaveEnabled = true;
        };

        const addMessage = (inner, sender) => {
            const div = document.createElement('div');
            div.className = `message ${sender}`;
            div.innerHTML = `<span>${sender === 'openai' ? marked.parse(inner) : inner}</span>`;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        // --------- STREAMING OPENAI ---------
        const streamOpenAI = async ({
            urlBase,
            apiKey,
            model,
            conversation,
            onChunk,
            onDone,
            onError,
        }) => {
            const startTime = performance.now();
            let lastText = '';
            let tokenCount = 0;
            let done = false;
            try {
                const response = await fetch(`${urlBase}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        Authorization: urlBase.includes('openai.azure.com')
                            ? apiKey
                            : `Bearer ${apiKey}`,
                        'api-key': urlBase.includes('openai.azure.com')
                            ? apiKey
                            : undefined,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model,
                        messages: conversation,
                        stream: true,
                    }),
                });

                if (!response.ok) throw new Error('Response error');
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let buffer = '';

                while (true) {
                    const { value, done: doneReading } = await reader.read();
                    if (doneReading) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (let line of lines) {
                        line = line.trim();
                        if (!line.startsWith('data:')) continue;
                        const jsonStr = line.replace('data:', '').trim();
                        if (jsonStr === '[DONE]') {
                            done = true;
                            break;
                        }
                        try {
                            const parsed = JSON.parse(jsonStr);
                            const delta = parsed.choices[0]?.delta?.content ?? '';
                            if (delta) {
                                lastText += delta;
                                tokenCount++;
                                onChunk?.(
                                    lastText,
                                    tokenCount,
                                    (performance.now() - startTime) / 1000,
                                );
                            }
                        } catch {}
                    }
                    if (done) break;
                }
                onDone?.(
                    lastText,
                    tokenCount,
                    (performance.now() - startTime) / 1000,
                );
            } catch (err) {
                onError?.(err);
            }
        };

        // --------- RESTORE HISTORY ON INIT ---------
        restoreHistory();

        // --------- STREAMING AND SENDING ----------
        let messageCounter = 0;

        chatForm.addEventListener('submit', e => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            addMessage(text, 'user');
            userInput.value = '';

            const config =
                JSON.parse(localStorage.getItem('chatConfig-global')) || {};
            const sysPrompt = config.systemPrompt || '';

            conversation.push({ role: 'user', content: text });
            saveConversation();

            let convToSend = conversation.slice();
            if (
                sysPrompt &&
                !(convToSend.length && convToSend[0].role === 'system')
            ) {
                convToSend = [{ role: 'system', content: sysPrompt }, ...convToSend];
            }

            // NOTE: Saving the message twice is redundant,
            // but was kept in the original code for compatibility.
            // conversation.push({ role: 'user', content: text });
            // saveConversation();

            messageCounter++;
            const replyId = `streamreply-${messageCounter}`;
            const speedId = `speed-${messageCounter}`;
            const htmlStream = `<span id="${replyId}"></span><br><small id="${speedId}" class="speed-indicator"></small>`;
            addMessage(htmlStream, 'openai');
            const replyElem = document.getElementById(replyId);
            const speedElem = document.getElementById(speedId);
            const msgDiv = chatMessages.lastChild;

            let lastRendered = 0;
            const RENDER_EACH = 10;

            streamOpenAI({
                urlBase: urlBaseInput.value.trim(),
                apiKey: apiKeyInput.value.trim(),
                model: modelInput.value.trim(),
                conversation: convToSend,
                onChunk: (content, tokens, seconds) => {
                    if (tokens - lastRendered >= RENDER_EACH || tokens === 1) {
                        replyElem.innerHTML = marked.parse(content);
                        lastRendered = tokens;
                    }
                    if (tokens > 0)
                        speedElem.innerText = `Tokens: ${tokens} • Speed: ${(tokens / (seconds || 1)).toFixed(2)} tks/sec`;
                    msgDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
                },
                onDone: (content, tokens, seconds) => {
                    if (content) {
                        conversation.push({ role: 'assistant', content });
                        saveConversation();
                    }
                    replyElem.innerHTML = marked.parse(content);
                    speedElem.innerText = `Done. Total tokens: ${tokens}, Max speed: ${(tokens / (seconds || 1)).toFixed(2)} tks/sec`;
                },
                onError: err => {
                    chatMessages.lastChild.remove();
                    addMessage('Connection error (streaming failed).', 'openai');
                },
            });
        });

        // --------- NEW CHAT ----------
        const newChatBtn = document.getElementById('newChatBtn');
        newChatBtn.addEventListener('click', () => {
            if (
                confirm(
                    'Are you sure you want to start a new chat? Current conversation will be deleted.',
                )
            ) {
                const newId =
                    self.crypto?.randomUUID?.() ||
                    `${Date.now().toString(36)}${Math.random()
                        .toString(36)
                        .substring(2, 8)}`;
                window.location.search = `?chat=${newId}`;
            }
        });

        // --------- NOTIFICATION ---------
        const showAlert = (text, timeout = 1800) => {
            const div = document.createElement('div');
            div.className = 'alert alert-success position-fixed shadow';
            div.style =
                'top: 16px; left:50%; transform:translateX(-50%); z-index:1000; min-width:200px; text-align:center;';
            div.textContent = text;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), timeout);
        };
    </script>
</body>
</html>
